<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requirement Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }
        .status-badge {
            font-size: 0.8em;
            padding: 6px 12px;
            border-radius: 20px;
            color: #fff;
        }
        .bg-draft { background-color: #6c757d !important; }
        .bg-approved { background-color: #28a745 !important; }
        .bg-rejected { background-color: #dc3545 !important; }
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h2 class="mb-0">
                            <i class="fas fa-clipboard-list me-2"></i>
                            Requirement Dashboard
                        </h2>
                        <p class="mb-0 mt-2">Track requirement generation and purchase orders</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Requirements Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Requirements</h5>
                    </div>
                    <div class="card-body">
                        <div id="requirements-table-container">
                            <div class="loading">Loading requirements data...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Receipt Modal -->
    <div class="modal fade" id="purchaseReceiptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Purchase Receipt</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="po-items-container">
                        <!-- PO items will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createPurchaseReceipt()">Create Receipt</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPurchaseOrder = null;
        let purchaseReceiptModal = null;

        function loadRequirementsData() {
            const container = document.getElementById('requirements-table-container');
            container.innerHTML = '<div class="loading">Loading requirements data...</div>';
            
            fetch('/api/method/qonevo.api.get_requirement_dashboard_data')
                .then(res => res.json())
                .then(res => {
                    if (res.message) {
                        updateRequirementsTable(res.message);
                    } else {
                        container.innerHTML = '<div class="loading">No data found.</div>';
                    }
                })
                .catch(() => {
                    container.innerHTML = '<div class="loading">Failed to load data.</div>';
                });
        }

        function updateRequirementsTable(data) {
            const container = document.getElementById('requirements-table-container');
            if (!data || !data.length) {
                container.innerHTML = '<div class="loading">No requirements found.</div>';
                return;
            }
            
            let html = `<div class="table-responsive"><table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Requirement</th>
                        <th>Date</th>
                        <th>Supplier</th>
                        <th>Status</th>
                        <th>Approved Items</th>
                        <th>Total Amount</th>
                        <th>Purchase Order</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>`;
            
            data.forEach(req => {
                const statusClass = req.status === 'Draft' ? 'draft' : 
                                  req.status === 'Approved' ? 'approved' : 'rejected';
                
                html += `<tr>
                    <td><a href="/app/requirement-generation/${req.name}" target="_blank">${req.name}</a></td>
                    <td>${req.date || 'N/A'}</td>
                    <td>${req.supplier_name || req.supplier || 'N/A'}</td>
                    <td><span class="status-badge bg-${statusClass}">${req.status}</span></td>
                    <td>${req.approved_items || '0/0'}</td>
                    <td>${req.total_amount || 0}</td>
                    <td>${req.purchase_order ? `<a href="/app/purchase-order/${req.purchase_order}" target="_blank">${req.purchase_order}</a>` : 'N/A'}</td>
                    <td>`;
                
                if (req.purchase_order) {
                    html += `<button class="btn btn-sm btn-primary" onclick="showPurchaseReceiptModal('${req.purchase_order}')">
                        <i class="fas fa-plus"></i> Create Receipt
                    </button>`;
                }
                
                html += `</td></tr>`;
            });
            
            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        function showPurchaseReceiptModal(purchaseOrder) {
            currentPurchaseOrder = purchaseOrder;
            
            // Load PO items
            fetch(`/api/resource/Purchase Order/${purchaseOrder}`)
                .then(res => res.json())
                .then(res => {
                    if (res.data) {
                        loadPOItems(res.data.items);
                        purchaseReceiptModal.show();
                    }
                })
                .catch(() => {
                    alert('Failed to load Purchase Order details');
                });
        }

        function loadPOItems(items) {
            const container = document.getElementById('po-items-container');
            let html = '<div class="table-responsive"><table class="table table-bordered">';
            html += '<thead><tr><th>Item</th><th>Ordered Qty</th><th>Accepted Qty</th><th>Rejected Qty</th><th>Remarks</th></tr></thead><tbody>';
            
            items.forEach((item, index) => {
                html += `<tr>
                    <td>${item.item_code} - ${item.item_name}</td>
                    <td>${item.qty}</td>
                    <td><input type="number" class="form-control accepted-qty" data-item="${item.item_code}" value="${item.qty}" max="${item.qty}"></td>
                    <td><input type="number" class="form-control rejected-qty" data-item="${item.item_code}" value="0" max="${item.qty}"></td>
                    <td><input type="text" class="form-control remarks" data-item="${item.item_code}" placeholder="Remarks"></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function createPurchaseReceipt() {
            const items = [];
            const acceptedInputs = document.querySelectorAll('.accepted-qty');
            const rejectedInputs = document.querySelectorAll('.rejected-qty');
            const remarksInputs = document.querySelectorAll('.remarks');
            
            acceptedInputs.forEach((input, index) => {
                const itemCode = input.dataset.item;
                const acceptedQty = parseFloat(input.value) || 0;
                const rejectedQty = parseFloat(rejectedInputs[index].value) || 0;
                const remarks = remarksInputs[index].value || '';
                
                items.push({
                    item_code: itemCode,
                    accepted_qty: acceptedQty,
                    rejected_qty: rejectedQty,
                    remarks: remarks
                });
            });
            
            fetch('/api/method/qonevo.api.create_purchase_receipt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    purchase_order: currentPurchaseOrder,
                    items_data: items
                })
            })
            .then(res => res.json())
            .then(res => {
                if (res.message) {
                    alert(`Purchase Receipt ${res.message} created successfully!`);
                    purchaseReceiptModal.hide();
                    loadRequirementsData(); // Refresh the table
                } else {
                    alert('Failed to create Purchase Receipt');
                }
            })
            .catch(() => {
                alert('Failed to create Purchase Receipt');
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            purchaseReceiptModal = new bootstrap.Modal(document.getElementById('purchaseReceiptModal'));
            loadRequirementsData();
        });
    </script>
</body>
</html> 